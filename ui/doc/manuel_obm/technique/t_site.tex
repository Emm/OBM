% Documentation technique d'OBM : Configuration specifique à un site
% ALIACOM Pierre Baudracco
% $Id$

\section{Configuration spécifique d'un site}

Depuis la version 0.8, OBM est pensé pour faciliter la personnalisation d'une mise en oeuvre en restant compatible avec le produit générique.

Pour ce faire les options de configurations et les données spécifiques d'un site sont situées dans un fichier et un répertoire dédiés.\\

\begin{tabular}{|p{7cm}|p{5cm}|}
\hline
Fichier de configuration spécifique & obminclude/obm\_conf.inc \\
\hline
Répertoire de configuration spécifique & obminclude/site \\
\hline
\end{tabular}


\subsection{Les options de paramétrage}

Ces paramètres sont définis en valeur par défaut dans le fichier global.inc mais peuvent être modifiées dans le fichier spécifique au site obm\_conf.inc :\\

\begin{tabular}{|p{7cm}|p{5cm}|}
\hline
Fichier de défintion des valeurs par défaut & obminclude/global.inc \\
\hline
Fichier de configuration spécifique & obminclude/obm\_conf.inc \\
\hline
\end{tabular}
\vspace{0.3cm}

Liste des paramètres définis :\\


\begin{longtable}{|p{3.7cm}|p{0.8cm}|p{3cm}|p{7cm}|}
\hline
\textbf{Option} & \textbf{Depuis} & \textbf{Défaut} & \textbf{Description} \\
\hline
\hline
\multicolumn{4}{c}{\textbf{Paramètres globaux}}\\
\hline
\hline
\$cgp\_host & & http://obm/ & Hôte utilisé dans les liens (ex dans les mails envoyés) \\ 
\hline
\$c\_home\_redirect & 1.1.3 & & Redirection pour la page d'accueil (permettant par exemple d'arriver directement sur l'agenda) \\ 
\hline
\$cgp\_site\_include & & false & Si vrai OBM utilise le répertoire spécifique obminclude/site pour les langues.\\ 
\hline
\$cgp\_todo\_nb & & 5 & Nombre de Todo affichés \\ 
\hline
\$popup\_width & & 620 & Largeur en pixels des popups \\ 
\hline
\$popup\_height & & 480 & Hauteur en pixels des popups \\ 
\hline
\$cak\_prev & & P & ACCESSKEY pour page précédente \\ 
\hline
\$cak\_next & & N & ACCESSKEY pour page suivante \\ 
\hline
\$cak\_page\_prev & & 4 & ACCESSKEY pour groupe de pages précédent \\ 
\hline
\$cak\_page\_prev & & 6 & ACCESSKEY pour groupe de pages suivant \\ 
\hline
\$cak\_begin & & B & ACCESSKEY pour début de résultat \\ 
\hline
\$cak\_prev & & E & ACCESSKEY pour fin de résultat \\ 
\hline
\$cg\_adm & & 1 & Groupe Administrateur utilisé par section Administration \\ 
\hline
\$cg\_com & & 2 & Groupe Commercial utilisé par section Commercial \\ 
\hline
\$cg\_prod & & 3 & Groupe Production utilisé par section Production \\ 
\hline
\$cql\_max\_row & & 50 000 & Maximum de lignes de résultat autorisé pour une requête manuelle utilisateur (module \List)\\ 
\hline
\$cql\_max\_cost & & 100 000 & Coût maximum autorisé pour une requête manuelle utilisateur (module \List)\\ 
\hline
\$cgp\_sql\_star & & true & Traite le caractère * comme un joker dans les recherches \\ 
\hline
\$ctu\_sql\_limit & & false & Indique si les requêtes envoyées à la base de données doivent gérer la clause limit afin de restreindre les résultats au niveau base de données à la place de l'affichage \\ 
\hline
\$cmy\_character\_set & & & Indique le jeu de caractères utilisé (base + fichiers). (uniquement pour MySQL 4.1 et +) \\ 
\hline
\$cmy\_charset\_collation & & & Indique la collation du jeu de caractères utilisé (base + fichiers). (uniquement pour MySQL 4.1 et +) \\ 
\hline
\$cgp\_mail\_enabled & & false & Indique si l'envoi de mail est activé pour OBM\\
\hline
\$cs\_lifetime & & 7200 & Durée de session. Temps d'inactivité avant déconnexion \\ 
\hline
\$cgp\_sess\_db & & false & Indication de stockage des sessions en base de données \\ 
\hline
\$cgp\_cookie\_name & 1.0.4 & OBM\_Session & Nom du cookie utilisé par \obm \\ 
\hline
\$cgp\_cookie\_domain & 1.0.4 & aliacom.local & Domaine de validité du cookie (utilisation avec Aliamin) \\ 
\hline
\$auth\_kind\footnotemark[1] & & 'standalone' & "standalone" pour gérer les
authentifications dans la base OBM, "CAS" pour passer par un serveur CAS \\ 
\hline
\$cas\_server & & aucune & nom ou IP du serveur CAS. Utilisé seulement
si le mode d'authentification est "CAS". \\ 
\hline
\$cas\_server\_port & & aucune & port du service CAS sur le serveur. Utilisé seulement si le mode d'authentification est "CAS". \\ 
\hline
\$cas\_server\_uri & & aucune  &  URI du service CAS sur le
serveur. Utilisé seulement si le mode d'authentification est "CAS".\\  
\hline
\$auth\_encryption & & true & Indique si la page de login doit chiffrer le mot de passe transmis (support de md5 uniquement) \\ 
\hline
\$password\_encryption & & md5 & Indique le format de stockage des mots de passe en base de données (plain | md5 | crypt) \\ 
\hline
\$c\_use\_connectors & & false & Indique l'utilisation de connecteurs (Evolution, Outlook) qui engendre des traitements supplémentaires \\ 

\hline
\hline
\multicolumn{4}{c}{\textbf{Paramètres spéciques aux modules}}\\
\hline
\hline
\$cclipboard\_address & 1.1.0 & tableau & Définition des champs d'adresse à intégrer dans le presse-papier \\ 
\hline
\$caf\_company\_name & & false & Indicateur de formatage automatique du nom de société \\ 
\hline
\$caf\_town & & false & Indicateur de formatage automatique du nom de ville \\ 
\hline
\$csearch\_advanced\_default & 1.1.0 & false & Indicateur de sélection de recherche avancée par défaut (société et contact)\\ 
\hline
\$cgp\_mailing\_default & & true & Indicateur contact ``activé pour mailing'' par défaut \\ 
\hline
\$ccontact\_private\_default & & false & Indicateur contacts sont privés par défaut \\ 
\hline
\$cagenda\_public\_groups & & false & Indicateur d'affichage des groupes publics dans l'agenda \\ 
\hline
\$cagenda\_weekstart & & ``monday + 2 hours'' & 1er jour d'une semaine dans l'agenda \\ 
\hline
\$cagenda\_first\_hour & & 8 & Heure de début de journée affichée dans l'agenda \\ 
\hline
\$cagenda\_last\_hour & & 20 & Heure de fin de journée affichée dans l'agenda \\ 
\hline
\$c\_day\_fraction & & 8 & Nombre de fractions d'une journée (gestion des temps)\\ 
\hline
\$c\_working\_days & & 0,1,1,1,1,1,0 & Journées travaillées, débute à dimanche (gestion des temps)\\ 
\hline
\$c\_week\_first\_day & & 1 & Premier jour de la semaine (0=dimanche, 1=lundi,..) (gestion des temps)\\ 
\hline
\$cmail\_incident & & & Adresse e-mail de destination des messages automatiques du module Incident \\ 
\hline
\$cdocument\_root & 1.0.0 & /var/www/obmdocs & Chemin du dépôt de document sur disque \\ 
\hline
\$default\_path & & / & Répertoire par défaut dans le dépot de documents \\ 
\hline
\$default\_mime & & application/octet-stream & Type mime par défaut des documents \\ 
\hline
\$tmp\_path & & /tmp & Chemin pour stockage temporaire (module import) \\ 
\hline
\$cgroup\_private\_default & & false & Indicateur groupes sont privés par défaut \\ 
\hline
\$cbackup\_path & 1.0.0 & /var/www/obmbackup & Chemin du dépôt de sauvegardes sur disque \\ 

\hline
\hline
\multicolumn{4}{c}{\textbf{Paramètres d'affichage des sections, modules et champs}}\\
\hline
\hline
\$cgp\_show & & Voir \ref{cgp_show_section} et \ref{cgp_show_module} & Indicateurs d'affichage des sections et modules \\ 
\hline
\$cgp\_hide & & Voir \ref{cgp_hide} & Indicateurs d'affichage des champs \\ 
\hline
\end{longtable}

\footnotetext[1]{L'installation de l'authentification CAS est
  détaillée dans la documentation Aliamin. En attendant l'unification
  entre ces deux documentations, merci de vous référer à cette dernière.}


\subsection{La définition des sections}
\label{cgp_show_section}

Pour définir une section dans \obm, il faut la déclarer dans le fichier de configuration.


\subsubsection{Configuration générique par défaut}

Liste des sections définies par défaut :\\
\begin{itemize}
\item com
\item prod
\item compta
\item user
\item admin
\item aliamin
\end{itemize}
\vspace{0.3cm}

Par défaut toutes les sections pointent vers le premier module de la section.


\subsubsection{Personnalisation des sections}

\obm permet de définir :\\
\begin{itemize}
\item Ses propres sections
\item L'ordre d'affichage des sections
\item Les urls pointées par les sections
\item Les labels affichés des sections
\end{itemize}

\paragraph{Remarque} Le droit d'accès à une section est défini dans les profils.\\

Le tableau \textbf{\$cgp\_show[``section'']} définit les sections utilisées par OBM.

\paragraph{Sections propres et ordre d'affichage}

Pour ne pas utiliser les sections génériques ou redéfinir l'ordre d'affichage des sections il est nécessaire de ``vider'' ce tableau avant d'y associer de nouvelles valeurs.
 
\paragraph{Définition des urls}

Pour chaque section il est possible de déclarer 1 paramètre, l'url; exemple pour la section ``com'' (définition de \$cgp\_show[``section''][``com'']) :\\

\begin{tabular}{|p{2.5cm}|p{5.5cm}|p{5cm}|}
\hline
\textbf{Paramètre} & \textbf{Défaut} & \textbf{Description} \\
\hline
url & \$path/company/company\_index.php & url pointée par la section \\ 
\hline
\end{tabular}

\paragraph{Définition du label de la section}
Le label de la section (affiché par l'onglet) est automatiquement la variable de langue \$l\_section\_com (pour la section com).
Il doit donc être défini dans les fichiers de langues spécifiques, pour les sections non pré-définies par \obm.

\paragraph{Exemple de définition :} Uniquement section admin
\begin{verbatim}
$cgp_show["section"] = ""; // Needed if module order to change
$cgp_show["section"]["admin"]["url"] = "$path/admin/admin_index.php?mode=html";
\end{verbatim}


\subsubsection{Evolutions d'\obm}

\begin{itemize}
\item La configuration des liens des sections est disponible depuis \obm 0.8.1 et a évolué à la version 0.9.0.
\item A partir d'OBM 0.9.0, aucune section ou paramètre de section ne sont définis en dur dans le code et l'administrateur définit les sections et leurs modules uniquement via le fichier de configuration.
\end{itemize}


\subsection{La définition des modules affichés}
\label{cgp_show_module}

\obm permêt de définir, via le fichier de configuration, quels modules sont disponibles et dans quelle section.


\subsubsection{Configuration générique par défaut}

\begin{tabular}{|p{2.5cm}|p{4cm}|}
\hline
\textbf{Section} & \textbf{Module} \\
\hline
\multirow{8}{4cm}{com} & company \\ 
\cline{2-2}
& contact \\
\cline{2-2}
& deal \\
\cline{2-2}
& list \\
\cline{2-2}
& agenda \\
\cline{2-2}
& todo \\
\cline{2-2}
& publication \\
\cline{2-2}
& statistic \\
\hline
\multirow{5}{2cm}{prod} & \timemanager \\ 
\cline{2-2}
& project \\
\cline{2-2}
& contract \\
\cline{2-2}
& incident \\
\cline{2-2}
& document \\
\hline
\multirow{3}{2cm}{compta} & account \\ 
\cline{2-2}
& invoice \\
\cline{2-2}
& payment \\
\hline
\multirow{4}{2cm}{user} & settings \\ 
\cline{2-2}
& user \\
\cline{2-2}
& group \\
\cline{2-2}
& resource \\
\hline
\multirow{7}{2cm}{user} & admin \\ 
\cline{2-2}
& admin\_code \\
\cline{2-2}
& admin\_pref \\
\cline{2-2}
& admin\_data \\
\cline{2-2}
& admin\_lang \\
\cline{2-2}
& admin\_ref \\
\cline{2-2}
& import \\
\hline
\end{tabular}


\subsubsection{Personnalisation des modules}

\obm permêt de définir :\\
\begin{itemize}
\item Les modules visibles ou utilisés
\item L'association des modules aux sections
\item L'ordre d'affichage des modules
\end{itemize}
\vspace{0.3cm}

Le tableau \textbf{\$cgp\_show[``module'']} définit les modules utilisées par OBM.

\subsubsection{Définition des modules visibles}

Pour ne pas afficher un module il faut insérer dans le fichier de configuration la ligne :

\begin{verbatim}
$cgp_show[``module''][``deal''] = false;
\end{verbatim}
\vspace{0.3cm}

ou bien re-définir l'ensemble des modules et ne définir que les modules souhaités : 

\begin{verbatim}  
$cgp_show[``module''] = "";
$cgp_show[``module'']["contact"] = "com";
\end{verbatim}

\paragraph{Association des modules aux sections}

La définition \$cgp\_show[``company''] = ``com'' associe le module company à la section com.

\paragraph{Ordre d'affichage des modules}

L'ordre d'affichage des modules dans une section est leur ordre de définition dans le fichier de configuration.


\subsubsection{Les dépendances entre modules}

Certains modules dépendent d'autres modules et sont automatiquement désactivés par \obm si un des modules dont ils dépendent est désactivé.
Par exemple le module \deal a besoin du module \company pour fonctionner et sera automatiquement désactivé si le module \company est désactivé.

Liste des modules dépendants :\\

\begin{tabular}{|p{3cm}|p{4cm}|}
\hline
\textbf{Module} & \textbf{Module dépendant} \\
\hline
\multirow{4}{2cm}{\company} & \deal \\ 
\cline{2-2}
& \project \\ 
\cline{2-2}
& \contract \\ 
\cline{2-2}
& \invoice \\ 
\hline
\contact & \List \\ 
\hline
\project & \timemanager \\ 
\hline
\contract & \incident \\ 
\hline
\invoice & \payment \\ 
\hline
\end{tabular}


\subsection{Le paramétrage des champs visibles}
\label{cgp_hide}

Afin de permettre des utilisations d'\obm d'orientations diverses, certains modules peuvent être paramétrés afin de ne pas afficher et gérer tous les champs prévus.

A partir de la version 0.8 d'\obm, les modules \company, \contact et \deal ont des champs paramétrables.\\

Le tableau \$cgp\_hide[``entity''] définit pour les modules cibles les champs devant être cachés.
Par défaut tous les champs sont affichés et il faut donc préciser explicitement les champs non souhaités.

Pour ne pas afficher un champ il faut insérer dans le fichier de configuration la ligne :

\begin{verbatim}  
$cgp_hide[``company''][``company_number''] = true;
\end{verbatim}  

Lorsqu'un champ est caché, il n'est plus disponible dans les critères de recherche, dans les listes de résultats ni dans les fiches de détail.\\

Les noms donnés aux champs du tableau \$cgp\_hide doivent être :\\
\begin{itemize}
\item soit \textbf{identiques aux noms des champs} retournés par la requête des listes de résultat, car la classe OBM\_DISPLAY utilise ces noms pour déterminer si les champs doivent être affichés ou non.
\item soit \textbf{identique au nom de la table liée} si le champ à masquer est un champ d'une table liée. Dans ce cas tous les champs de la table liée seront masqués (exemple : ``companyactivity'' pour masquer l'affichage de tous les champs, label, code,.. concernant les secteurs d'activités d'une société) 
\end{itemize}


\subsubsection{Utilisation des champs paramétrables dans \obm}

Les tests concernant les champs paramétrables, référencés ci-dessous, sont effectués dans différentes parties de l'affichage ainsi que dans certaines requêtes afin d'éviter des traitements inutiles :\\

\begin{itemize}
\item Affichage du formulaire de recherche (permettre ou non la recherche selon le champ) : test direct ou via \variable{of\_category}
\item Affichage d'un résultat de recherche (présence du champ ou de la famille de champ dans le résultat de recherche) : test via \variable{OBM\_DISPLAY}
\item Affichage de la consultation d'une entité : test direct ou via \variable{of\_category}
\item Affichage du formulaire d'une entité : idem consultation
\item Requête de listes de catégories ou tables liées : test directs.
\end{itemize}

\paragraph{tests via \variable{of\_category} :}

\variable{of\_category} reçoit en paramètres l'entité (ex: ``company'') et la catégorie (exemple: ``category1'').
Le test est effectué sur ``\$category'' et ``\$entity\$category''.


\paragraph{tests via \variable{obm\_display} :}

\variable{obm\_display} affiche les résultats de recherche. Elle reçoit les champs issus des préférences d'affichage.
Le test est effectué sur le nom du champ reçu, ainsi que sur la base du nom du champ avant le premier ``\_'' (ainsi \variable{\$cgp\_hide[``company''][``companyactivity] = true;} permet de désactiver ``companyactivity\_label'' et ``companyactivity\_code''.


\subsubsection{Les champs paramétrables du module \company}

Liste des champs paramétrables (masquables) du module \company :

\begin{verbatim}
// Company module
$cgp_hide["company"]["company_number"] = true;  // numéro
$cgp_hide["company"]["company_vat"] = true;     // numéro intracommunautaire
$cgp_hide["company"]["type"] = true;            // type
$cgp_hide["company"]["activity"] = true;        // secteur d'activité
$cgp_hide["company"]["nafcode"] = true;         // code NAF
$cgp_hide["company"]["category1"] = true;       // catégorie
$cgp_hide["company"]["company_address3"] = true;       // ligne adresse 3
$cgp_hide["company"]["company_expresspostal"] = true;  // Cedex
\end{verbatim}  


\subsubsection{Les champs paramétrables du module \contact}

Liste des champs paramétrables (masquables) du module \contact :

\begin{verbatim}
// Contact module
$cgp_hide["contact"]["function"] = true;          // fonction
$cgp_hide["contact"]["contact_title"] = true;     // titre
$cgp_hide["contact"]["responsible"] = true;       // responsible
$cgp_hide["contact"]["category1"] = true;         // catégorie 1
$cgp_hide["contact"]["category2"] = true;         // catégorie 2
$cgp_hide["contact"]["category3"] = true;         // catégorie 3
$cgp_hide["contact"]["category4"] = true;         // catégorie 4
$cgp_hide["contact"]["category5"] = true;         // catégorie 5
$cgp_hide["contact"]["contact_service"] = true;   // ligne service
$cgp_hide["contact"]["contact_address3"] = [AUTO] // ligne adresse 3
$cgp_hide["contact"]["contact_expresspostal"] = [AUTO]; // Cedex
$cgp_hide["contact"]["contact_comment2"] = true   // commentaire 2
$cgp_hide["contact"]["contact_comment3"] = true   // commentaire 3
\end{verbatim}  


\subsubsection{Les champs paramétrables du module \deal}

Liste des champs paramétrables (masquables) du module \deal :

\begin{verbatim}
// Company module
$cgp_hide["deal"]["category1"] = true;            // catégorie
\end{verbatim}  


\subsubsection{Les dépendances entre modules}

Certains champs apparaissent dans différents modules.
Par exemple le champ \variable{contact\_function} apparait dans les modules \contact et \List, et ce champ, défini dans le module \contact peut être masqué.
Pour les champs dépendants, \obm calcule donc automatiquement la visibilité en fonction des dépendances.
Liste des champs dépendants :\\

\begin{tabular}{|p{2.5cm}|p{3.5cm}|p{2.5cm}|p{3.5cm}|}
\hline
\textbf{Entité source} & \textbf{Champ source} & \textbf{Entité dépendante} & \textbf{Dépendance} \\
\hline
\multirow{3}{2cm}{company} & \multirow{3}{2cm}{company\_address3} & contact & contact\_address3 \\ 
\cline{3-4}
& & list\_contact & address3 \\ 
\cline{3-4}
& & list\_contact\_2 & address3 \\ 
\hline
\multirow{3}{2cm}{company} & \multirow{3}{2cm}{company\_expresspostal} & contact & contact\_expresspostal \\ 
\cline{3-4}
& & list\_contact & expresspostal \\ 
\cline{3-4}
& & list\_contact\_2 & expresspostal \\ 
\hline
\multirow{2}{2cm}{contact} & \multirow{2}{2cm}{function} & list\_contact & function \\ 
\cline{3-4}
& & list\_contact\_2 & function\_label \\ 
\hline
\end{tabular}
