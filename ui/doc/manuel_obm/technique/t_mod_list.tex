% Documentation technique d'OBM : module List
% ALIACOM Pierre Baudracco
% $Id$


\clearpage
\section{List}

révision : \obm 1.1.0

Le module \List \obm.

.\\
Todo\\
contacts statiques et dynamiques\\
2 listes affichées\\
tests des requetes (correction + limites ressources)\\
génération de la requete : addslashes dans elements du tableau criteria\\

\subsection{Organisation de la base de données}

Le module \List utilise 2 tables :
\begin{itemize}
 \item List
 \item ContactList
\end{itemize}
\vspace{0.3cm}

La table List stocke les informations générales sur les listes, la table ContactList assure la liaison des contacts statiques avec une liste.


\subsubsection{La table List}
Table principale des informations d'une liste.\\

\begin{tabular}{|p{3cm}|c|p{5.4cm}|p{2.6cm}|}
\hline
\textbf{Champs} & \textbf{Type} & \textbf{Description} & \textbf{Commentaire} \\
\hline
\_id & int 8 & Identifiant & Clé primaire \\
\hline
\_timeupdate & timestamp 14 & Date de mise à jour & \\
\hline
\_timecreate & timestamp 14 & Date de création & \\
\hline
\_userupdate & int 8 & Id du modificateur & \\
\hline
\_usercreate & int 8 & Id du créateur & \\
\hline
\_privacy & int 1 & Visibilité de la liste & \\
\hline
\_name & varchar 64 & Nom de la liste & \\
\hline
\_subject & varchar 128 & Sujet de la liste & \\
\hline
\_email & varchar 128 & Adresse E-mail de la liste & \\
\hline
\_mode & int 1 & Mode (Normal=0 ou Expert=1) & \\
\hline
\_mailing\_ok & int 1 & Indicateur de prise en compte d'activation pour mailing & \\
\hline
\_static\_nb & int 10 & Nombre de contacts statiques (directs) associés à la liste & \\
\hline
\_query\_nb & int 10 & Nombre total de contacts de la liste & \\
\hline
\_query & text (64k) & Requête sauvegardée des critères (modes normal et expert) & \\
\hline
\_structure & text (64k) & Description des critères du mode normal (graphique) &\\
\hline
\end{tabular}


\subsubsection{Le champ query}

Ce champ stocke la requête SQL générée manuellement (mode expert) ou automatiquement en fonction des critères (mode normal).


\subsubsection{Le champ structure (critères)}

Ce champ stocke les critères de recherche saisis graphiquement.
A noter : le tableau des critères est sérialisé pour stockage dans ce champ.


\subsubsection{La table ContactList}
Table de liaison entre une liste et ses contacts statiques.\\

\begin{tabular}{|p{3cm}|c|p{5.4cm}|p{2.6cm}|}
\hline
\textbf{Champs} & \textbf{Type} & \textbf{Description} & \textbf{Commentaire} \\
\hline
\_list\_id & int 8 & Identifiant de la liste & \\
\hline
\_contact\_id & int 8 & Identifiant du contact & \\
\hline
\end{tabular}


\subsection{Détermination mode normal ou mode expert}

Depuis \obm 1.1.0, le champ ``list\_mode'' détermine le mode de requête.

A noter que les critères graphiques sont conservés lorsque la liste bascule en état expert.
Ce qui permet de revenir en mode ``normal'' en retrouvant les critères du moment de la bascule.


\subsection{Construction des requètes dynamiques}

La construction de la requète selon les critères demandés est effectuée par la fonction \fonction{maque\_query\_from\_criteria()}.


\subsubsection{Informations de publication}

La série de critère "\publication" permet de rechercher des contacts selon leurs abonnements aux publications.

La sélection de la case à cocher "Information des publications" permet d'afficher dans les listes de résultat les informations de publication associées aux contacts.
Une conséquence importante est que ceci modifie en profondeur le résultat de la liste, qui devient une liste d'associations contact - publication (un contact pourra apparaître plusieurs fois selon ses abonnements).

Lorsque les informations de publication sont demandées, il devient impossible de cumuler un même critère de publication par un ET. (Exemple : publication dont le titre est "TITRE1" et dont le titre est "TITRE2"), car une ligne de résultat ne contient qu'une publication et ne correspondra donc jamais.


\subsubsection{Problématique des liaisons n-n}

Certains critères comme les catégories de société ou de contact et les publications correspondent à des liaisons n-n entre contact et le critère demandé.

Ceci impose un traitement particulier des liens.
La demande d'un de ces critères nécessite l'insertion d'une jointure (LEFT JOIN) dans la requète.
La complexité vient de trois facteurs :\\
\begin{itemize}
\item Lorsqu'un de ces critères est combiné avec lui-même par un ET, cela implique de créer une jointure supplémentaire (Société de catégorie 1 ET de catégorie 2 va nécessiter 2 jointures vers les catégories de société).
\item Dans le cas des informations de publication, tous les critères ajoutent la même jointure.
Il faut donc veiller à ne pas ajouter la jointure si elle a déjà été ajoutée par un critère différent de publication.
\end{itemize}
\vspace{0.3cm}

La variable \variable{\$join\_nb["field"]} permet de référencer le nombre de jointures associé au champ field.

La variable \variable{\$join\_nb["module"]} permet de référencer le nombre de jointures associé au module, nécessaire pour le module \publication ou tous les critères impliquent la même jointure.\\

L'algorithme de gestion des critères et d'ajout des jointures pour la construction de la requète est donc, au traitement d'un critère :\\

\begin{tabular}{|l|p{4.5cm}|p{5.5cm}|}
 \hline
 \textbf{Condition} & \textbf{Condition} & \textbf{Action de jointure} \\
 \hline
 \hline
  \#join champ est null & \#join module null OU module!=publication & Ajout de la jointure assoicée au champ. \\ 
 \hline
  \#join champ est null & \#join module non null ET module=publication & Rien. \\ 
 \hline
  \#join champ non null & ligne combinée par AND et même critère & Ajout de la jointure (si \#join du champ > \#join du module, ceci pour traiter le cas du module publication). \\
 \hline
\end{tabular}


\subsection{Actions et droits}

Voici la liste des actions du module \List, avec le droit d'accès requis ainsi qu'une description sommaire de chacune d'entre elles.\\

\begin{tabular}{|l|c|p{9.5cm}|}
 \hline
 \textbf{Intitulé} & \textbf{Droit} & \textbf{Description} \\
 \hline
 \hline
  index & read & (Défaut) formulaire de recherche de listes. \\ 
 \hline
  search & read & Résultat de recherche. \\
 \hline
  new & write & Formulaire de création d'une liste. \\
 \hline
  new\_criterion & write & Formulaire de saisie d'un nouveau critère graphique. \\
 \hline
  detailconsult & read & Fiche détail d'une liste. \\
 \hline
  detailupdate & write & Formulaire de modification d'une liste. \\
 \hline
  insert & write & Insertion d'une liste. \\
 \hline
  update & write & Mise à jour d'une liste. \\
 \hline
  check\_delete & write & Vérification avant suppression d'une liste. \\
 \hline
  delete & write & Suppression d'une liste. \\
 \hline
  contact\_add & write & Ajouts de contacts statiques à la liste\\
 \hline
  contact\_del & write & Suppression de contacts statiques de la liste\\
 \hline
\end{tabular}
