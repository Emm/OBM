<HTML>
<!-- $Id$ -->
<BODY BGCOLOR="#FFFFFF">

<A HREF="index.html">back</A>

<p>These docs are valid for OBM 0.5.3.
<br>
OBM 0.5 works with PHP4. <b>PHP3 is no longuer supported !</b>

<H1>Basic steps to build and install OBM 0.5.x</H1>

<h2>.deb, .rpm or other package install</h2>
For pre-packaged distributions, check in your distribution docs.
<br>
In Debian, install php4, php4-cgi, php4-mysql, apache, apache-common
<p>
Then jump to step 4 from source install.


<h2>Source install</h2>
<OL>
<LI> Get the source (should be done if you have this file)
<LI> Install MySQL or PostgreSQL if not on your system.
<LI> Build and Install Apache with PHP module activated.
<OL>
   <LI> Build PHP with MySQL or PostgreSQL support (or both !)
   <LI> Build Apache with PHP module.
</OL>
<LI> Configure apache to process PHP files, and test it (with test.php3) !
<OL>
   <LI> Configure the Apache document root.
   <LI> Configure apache to process PHP files.
   <LI> Restart Apache and test it.
</OL>
<LI> Configure PHP (include path in "php.ini" ...).
<LI> Create the OBM database
<LI> Set up initial values
<LI> Copy everything in the php directory somewhere in your Web document tree.
<LI> Select the database (MySQL or PostgreSQL) for phplib.
<LI> Run OBM (access the obm.php from your browser).
</OL>

<H1> Detailed Installation </H1>

Here is a more detailed guideline to install obm.
For mysql, postgresql, apache and php install parts, if you encounter troubles I suggest you look into their own documentations.
<P>
We suppose that (as an example, only needed for 5: and 8:)
<BR>the web Document root is /home/web
<BR>the obm root is /home/web/obm
<P>


<H2>1: Get the source</H2>
# Would be more difficult without it


<H2>2: Installing MySQL or PostgreSQL</H2>
# Follow their own documentation

<H2>3: Build and Install Apache with PHP module activated</H2>
# Basically the steps are:
<BR># Desarchive in the same directory

<P>gunzip apache_1.3.x.tar.gz
<BR>tar xvf apache_1.3.x.tar
<BR>gunzip php-4.x.x.tar.gz
<BR>tar xvf php-4.x.x.tar
<P>
# A first ./configure of apache seems to be needed
<P>
cd apache_1.3.x
<BR>./configure

<H3>3.1: Build PHP with MySQL or PostgreSQL support</H3>

cd ../php-X.0.x
<BR># For MySQL
<BR>./configure --with-mysql --with-apache=../apache_1.3.x --enable-track-vars
<BR># For PostgreSQL
<BR>./configure --with-pgsql --with-apache=../apache_1.3.x --enable-track-vars
<BR>make
<BR>make install

<H3>3.2: Build and Install Apache</H3>
$ cd ../apache_1.3.x
<BR>$ ./configure --activate-module=src/modules/php/libphp.a
<BR>$ make
<BR>$ /usr/local/apache/bin/apachectl stop
<BR>$ make install

<H2>4: Configure apache, and test it (with test.php) !</H2>
<H3>4.1: [0.5.0 - 0.5.1] Configure the Apache document root</H3>
# Edit your httpd.conf and modify the DocumentRoot and its Directory entries:
<BR>DocumentRoot "/home/web"
<BR>...
<BR><Directory "/home/web">
<P>
# or you can keep the default configuration which could be
<BR>DocumentRoot "/usr/local/apache/htdocs"      # default from sources
<BR>DocumentRoot "/home/httpd"
<P>
We <b>strongly</b> recommend to prevent direct access to .inc files
<br>< Files "\.inc$">
<br>  Order allow,deny
<br>  Deny from all
<br>< /Files>
</pre>
<h3>4.1: [0.5.2]+ specific config</h3>
Since 0.5.2 obminclude is by default outside the document root for <b>security</b> reasons.
<br>We encourage to set up a virtual host to handle one occurence of OBM (there can be several now on one server).
In this virtual host section set :

<p>
# Set your document root to : /home/web/obm/php
<br>as obminclude is in /home/web/obm/obminclude so outside the web tree.

<p># Set an alias to images in the themes directory:
<br>Alias /images path_to_obminclude/themes
<br><u>eg:</u> Alias /images /home/web/obm/obminclude/themes

<p># the name obminclude is now a variable to allow multiple OBM instances on the same code source base (only obminclude will differ which give different database, themes, langs... for each instances). This variable is set through the apache httpd.conf file.
<br># load the env module
<br>LoadModule env_module /usr/lib/apache/1.3/mod_env.so

<br>#fill the OBM_INCLUDE_VAR with the name of the obminclude dir
<br>Setenv OBM_INCLUDE_VAR obminclude

<p>
<u>Eg:</u>
<pre>
< VirtualHost 192.168.1.5>
    ServerAdmin root@localhost
    DocumentRoot /home/pierre/cvs/obm/php
    ServerName obm-panthere
    ErrorLog /var/log/apache/obm-error.log
    CustomLog /var/log/apache/obm-access.log common
    Alias /images /home/pierre/cvs/obm/obminclude/themes
    SetEnv OBM_INCLUDE_VAR obminclude
    DirectoryIndex obm.php
< /VirtualHost>
</pre>

<H3>4.2: Configure apache to process PHP files</H3>

# Edit your httpd.conf or srm.conf file and add:
<BR>AddType application/x-httpd-php .php

<H3>4.3: Restart Apache and test it</H3>
# Restart Apache
<BR>/usr/local/apache/bin/apachectl restart
<P>
# Open the test.php page with netscape


<H2>5: Configure PHP (include path in "php.ini" ...)</H2>
# Edit the php.ini file (/usr/local/lib/php.ini or /etc/php/apache/php.ini on Debian)
<BR># Add the phplib and the working directories in the include path
<BR>include_path = "what_was_here_before:/home/web/obm:."
<P># unfill the auto_prepend_file and auto_append_file vars.
<BR>auto_prepend_file = ;
<BR>auto_append_file = ;
<p>
It is also possible to put this config in the apache vitual host if set.
<pre>
     php_value include_path .:/home/web/obm:
or   php_value include_path .:/var/www/obm: (on Debian)
</pre>

<H2>6: Create the OBM database</H2>

<H3>6.1: Create the obm database - MySQL</H3>
# The SQL scripts are in the scripts/0.5 directory
<P>
# First, create the user web for mysql access to obm database
<BR>mysql -u root mysql    # or with the user who have the rights
<P>
# user web, password web (number of "Y" may vary with mysql versions)
<BR>insert into user values("localhost","web",password("web"),"Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y","Y");
<P>
# Because of the way the mysql access rights works you may have to remove the
<BR># standard access from localhost
<BR>delete from user where Host="localhost" and Select_priv="N";
<P>
# You have to restart the mysql daemon for the new acces rights to take effect
# or use mysqladmin
<P>
# create the database obm.
<BR># In any SQL editor
<BR>create database obm;
<P>

<h4>6.1.1 - Create the database Model</h4>
# Open the file create_obmdb_0.5.mysql.sql in an SQL editor and run it.
<BR># You may be forced to create each tables separatedly from an editor.
<BR># The simplest is to execute :
<BR>mysql -u web -pweb obm < create_obmdb_0.5.mysql.sql

<h4>6.1.2 - Populate the lang specific values</h4>
# For english people
<BR>mysql -u web -pweb obm < create_obmdb_0.5_en.mysql.sql
<BR># For french people
<BR>mysql -u web -pweb obm < create_obmdb_0.5_fr.mysql.sql
<P>
# restart mysql for the new access rights to be effective;
<BR># Or just reload the grant tables
<BR>mysqladmin -u user -p reload

<H3>6.2: Create the obm database - PostgreSQL</H3>
# The SQL scripts are in the scripts/0.5 directory
<P>
# create the database obm. Use the "postgres" user account or your postgres
admin account to create the database.
<BR># In a Unix shell editor, under the "postgres" unix user :
<BR>$ createdb obm;
<P>
# Run the file create_obm_db.pgsql.sql with psql
<BR>psql obm -f create_obmdb_0.5_en.pgsql.sql > createobm.err 2>&1
<BR># For french people it would be better to execute when available (database in french)
<BR>psql obm -f create_obmdb_0.5_fr.pgsql.sql > createobm.err 2>&1
<P>
Set environment variable for PostgreSQL use for postgres user in .bash_profile (for bash shell) :
<BR># PGLIB, PGDATA are set by default
<BR># add PGDATESTYLE not set by default:
<BR>export PGDATESTYLE=ISO

<H2>7: Set up initial values (default display preferences)</H2>
# The SQL script is in the scripts/0.5 directory
<BR>mysql -u web -pweb obm < obmdb_default_values_0.5.sql


<H2>8: [0.5.0, 0.5.1] Copy everything in the php directory somewhere in your Web document tree</H2>
# you must have write permissions on the web directory
<BR># we suppose you are in the obm directory
<P>
cp -r ./php/* /home/web/obm

<H2>8: [0.5.2+] Move the obm directory in your web tree</H2>
# you must have write permissions on the web directory
<P>
mv obm/ /home/web


<H2>9: Select the database (MySQL or PostgreSQL) for phplib</H2>
# in obminclue/phplib edit the file obmlib.inc and comment one of these two
lines :
<BR>require("obminclude/phplib/db_pgsql.inc");       ## Postgres
<BR>require("obminclude/phplib/db_mysql.inc");       ## Mysql
<P>
# then declare the right db type, user and password in the DB_OBM class (same file)
<BR>var $type     = $db_type_pgsql;   # for PostgreSQL
<BR>var $type     = $db_type_mysql;   # for MySQL
<P> # user and password (web ,web for mysql)
<BR>var $User     = "obm_user";       ## Postgres 
<BR>var $Password = "obm_pass";       ## Postgres 

<P>
# For example, if you want to use PostgreSQL :
<BR>require("obminclude/phplib/db_pgsql.inc");       ## Postgres
<BR>// require("obminclude/phplib/db_mysql.inc");    ## Mysql
<BR>...
<BR>class DB_OBM extends DB_Sql {
<BR>...
<BR>var $type     = $db_type_pgsql;
<BR>var $User     = "obm_user";
<BR>var $Password = "obm_pass";


<H2>10: Run OBM (access the obm.php from your browser)</H2>
# First restart your apache web server

<P>/usr/local/apache/bin/apachectl restart

<P># If all goes well run netscape and launch the url
<BR>yourserver/obm/obm.php

<P># Log in with the uadmin/padmin account

<p># Update stored values that are not calculated
<br>
# In OBM, from the admin module (must be connected with an admin user), select the Data menu and execute the action data_update for the company module (which update these values)


<P>
<br><br>
<A NAME="upgrade-0.5.0">
<H1>UPGRADE OBM DATABASE 0.4.1 to 0.5.0</H1></a>
<p>
# First you have to make backup copy of your current obm database : 
<br>create database obm_save; <i># In any SQL editor</i>
<br><br>mysqldump -u web -pweb obm > obm_dump.sql 
<br>mysql -u web -pweb obm_save < obm_dump.sql

<br><br>
# Then use the update sql script (in scripts/0.5): <br>
mysql -u web -pweb obm < update-0.4.x-0.5.0.mysql.sql   &nbsp;<i>  #or with the user who have the rights </i><br>
<b>Important :</b> For a postgres database the file is update-0.4.x-0.5.0.pgsql.sql
<br><br>

# then fill in the diplay default preferences with the sql script (scripts/0.5)<br>
mysql -u web -pweb obm < obmdb_default_values_0.5.sql
<br><br>

# then excute the perl script to fill new tables (in the same database):<br>
perl obmdb_export_0.4.x-0.5.0.pl <br>
<b>Important :</b> This script has to be configured as explain in obmdb_export_0.4.x-0.5.txt
<br><br>

# When all is ok you can run the last script which get rid of deprecated table (in the same database):<br>
mysql -u web -pweb obm < update-after-export-0.4.x-0.5.0.mysql.sql   &nbsp;<i>  #or with the user who have the rights </i><br>

<br><br>

<A NAME="upgrade-0.5.1">
<H1>UPGRADE OBM DATABASE 0.5.0 to 0.5.1</H1></a>
<p>
# Database has evolved from 0.5.0 to 0.5.1
<br>mysql -u web -pweb obm < scripts/0.5/update-0.5.0-0.5.1.mysql.sql
<br><br>
<A HREF="index.html">back</A>

<br><br>


<A NAME="upgrade-0.5.2">
<H1>UPGRADE OBM DATABASE 0.5.1 to 0.5.2</H1></a>
<p>
# Database has evolved from 0.5.1 to 0.5.2
<br>mysql -u web -pweb obm < scripts/0.5/update-0.5.1-0.5.2.mysql.sql
<p>
# Insert new default display values
<br>mysql -u web -pweb obm < scripts/0.5/obmdb_default_values_0.5.sql

<p>
# Reload default display values for each user
<br>
# In OBM, from the admin module (must be connected with an admin user), select the Prefs menu and execute the action (which reload defaut preferences for each user)

<p>
# Update stored values that are not calculated
<br>
# In OBM, from the admin module (must be connected with an admin user), select the Data menu and execute the action data_update for the company module (which update these values)


<h3>[0.5.2] specific config</h3>
Since 0.5.2 obminclude is by default outside the document root for <b>security</b> reasons.
<p>So now the OBM archive can be put directly on your web tree (no more copying the php directory content). After unpacking :
<br>mv obm/ /home/web
<br> or : mv obm /var/www (on Debian)

<p>Update the include path in the php.ini (if necessary)
<br>
It is also possible to put this config in the apache vitual host if set.
<pre>
     php_value include_path .:/home/web/obm:
or   php_value include_path .:/var/www/obm: (on Debian)
</pre>

<p>We encourage to set up a virtual host to handle one occurence of OBM (there can be several now on one server).
In this virtual host section :

<p>
# Set your document root to : /home/web/obm/php
<br>as obminclude is in /home/web/obm/obminclude so outside the web tree.

<p># Set an alias to images in the themes directory:
<br>Alias /images path_to_obminclude/themes
<br><u>eg:</u> Alias /images /home/web/obm/obminclude/themes

<p># the name obminclude is now a variable to allow multiple OBM instances on the same code source base (only obminclude will differ which give different database, themes, langs... for each instances). This variable is set through the apache httpd.conf file.
<br># load the env module
<br>LoadModule env_module /usr/lib/apache/1.3/mod_env.so

<br>#fill the OBM_INCLUDE_VAR with the name of the obminclude dir
<br>Setenv OBM_INCLUDE_VAR obminclude

<p>
<u>Eg:</u>
<pre>
< VirtualHost 192.168.1.5>
    ServerAdmin root@localhost
    DocumentRoot /home/pierre/cvs/obm/php
    ServerName obm-panthere
    ErrorLog /var/log/apache/obm-error.log
    CustomLog /var/log/apache/obm-access.log common
    Alias /images /home/pierre/cvs/obm/obminclude/themes
    SetEnv OBM_INCLUDE_VAR obminclude
#   php_value include_path .:/home/pierre/cvs/obm
    DirectoryIndex obm.php
< /VirtualHost>
</pre>


<A NAME="upgrade-0.5.3">
<H1>UPGRADE OBM DATABASE 0.5.2 to 0.5.3</H1></a>
<p>
# Database has evolved from 0.5.2 to 0.5.3
<br>mysql -u web -pweb obm < scripts/0.5/update-0.5.2-0.5.3.mysql.sql
<p>
# Insert new default display values
<br>mysql -u web -pweb obm < scripts/0.5/obmdb_default_values_0.5.sql

<p>
# Reload default display values for each user
<br>
# In OBM, from the admin module (must be connected with an admin user), select the <b>Prefs</b> menu and execute the action <b>user_pref_update</b> (which reload defaut preferences for each user)

<p>
# Update stored values that are not calculated
<br>
# In OBM, from the admin module (must be connected with an admin user), select the <b>Data</b> menu and execute the action <b>data_update</b> for the company module (which update these values)

<p>
# Database model update (what were internal contacts are now Obm users) need
some data reference update.
<br># Hence the scipt update-0.5.2-0.5.3.php (in scripts/0.5)
<br>
php update-0.5.2-0.5.3.php
<br>or (on Debian)
php4 update-0.5.2-0.5.3.php

<br><br>
<A HREF="index.html">back</A>

</BODY>
</HTML>
