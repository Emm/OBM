<HTML>
<HEAD>
<TITLE> OBM Development Guidelines </TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF">

<A HREF="index.html">back</A>

<CENTER>
<H1>OBM Development Guidelines</H1>
<I>Coding standards now mandatory to harmonize the OBM code</I><BR>
Version 0.5.3 - 2002-08-16<BR>
Pierre Baudracco
</CENTER>
<P>

<H2>Introduction</H2>
As OBM is evolving towards a more ambitious and complex application, we need
more rigorous coding standards.
<P>
This document describes what is now <b>mandatory</b> coding rules for OBM code.



<h2>OBM Files</h2>
<h3>File Size and global presentation</h3>

OBM is a web application and so is deployed on Internet/Intranet servers.
These servers are often accessed from distant computers (via telnet, ssh,...)
so OBM code has to be readable from a terminal in 80 col mode.
<P>
OBM line separators (comments, headers,...) should always be <b>79 chars</b> long and never more.
<p>
Indentation should be <b>2 characters</b> steps.
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
///////////////////////////////////////////////////////////////////////////////
</pre>
</td></tr>
</table>
<p>

Each truncated line should be so with this constraint in mind.
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
  $req = "select Company.*, company_id as Id, companytype_label
          from Company, CompanyType 
          where company_type_id=companytype_id";
</pre>
</td></tr>
</table>
<p>

Of course some lines should not be truncated (function definitions, ...)

<p>
HTML should always be writen in lower caps letters (yes there is a big update
here to do !)
<br>
HTML output should always be separated from process logic and should only contain simple vars. 
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
  $sel_market = ...
---------------------------------
  echo "
      < td>< font size=-2>$l_market< /font>< br>
        $sel_market
      < td>&nbsp;&nbsp;< /td>
      < td align=center>< font size=-2>$l_internal< /font>< br>
        < input type=\"checkbox\" name=\"cb_state\" value=\"1\" $cstate>< /td>
</pre>
</td></tr>
</table>
<p>


<h3>File Header</h3>

Each OBM file should have an header as described below :
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
///////////////////////////////////////////////////////////////////////////////
// OBM - File : company_index.php                                            //
//     - Desc : Company Index File                                           //
// 1999-03-19 Pierre Baudracco                                               //
///////////////////////////////////////////////////////////////////////////////
// $Id$ //
///////////////////////////////////////////////////////////////////////////////
</pre>
</td></tr>
</table>
<P>


<h2>Module Structure</h2>
OBM is divided into application modules (and soon sections, a section beeing a set of modules).
<p>
Each module must be divided into 4 files :
<ul type=disc>
         <li> <b>(1)</b> module_index.php
         <li> <b>(2)</b> module_display.inc
         <li> <b>(3)</b> module_query.inc
         <li> <b>(4)</b> module_js.inc<br><br>
</ul>

<table border=1>
<tr>
  <th>Module file</th>
  <th>Description</th>
</tr><tr>
  <td>module_index.php</td>
  <td>Main module file, is the module skeleton which calls and coordinates the functions contained in all the other files.<br>
The <i>$action</i> variable dictates the module execution.
  </td>
</tr><tr>
  <td>module_display.php</td>
  <td>Display module file which contains display functions
  </td>
</tr><tr>
  <td>module_query.php</td>
  <td>Query module file which contains query functions (database access)
  </td>
</tr><tr>
  <td>module_js.php</td>
  <td>Javascript module file which contains javascript functions.
  </td>
</tr>
</table>

<H3>The module index file : module_index.php</H3>

Each module index file must have an header, referencing all actions implemented, as described below :
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
///////////////////////////////////////////////////////////////////////////////
// OBM - File  : company_index.php                                           //
//     - Desc  : Company Index File                                          //
// 1999-03-19 Pierre Baudracco                                               //
///////////////////////////////////////////////////////////////////////////////
// $Id$ //
///////////////////////////////////////////////////////////////////////////////
// Actions           -- Parameter
// - index (default) -- search fields  -- show the company search form
// - search          -- search fields  -- show the result set of search
// - new             --                -- show the new company form
// - detailconsult   -- $param_company -- show the company detail
// - detailupdate    -- $param_company -- show the company detail form
// - insert          -- form fields    -- insert the company
// - update          -- form fields    -- update the company
// - check_delete    -- $param_company -- check links before delete
// - delete          -- $hd_company_id -- delete the company
// - admin           --                -- admin index (kind)
// - kind_insert     -- form fields    -- insert the kind
// - kind_update     -- form fields    -- update the kind
// - kind_checklink  --                -- check if kind is used
// - kind_delete     -- $sel_kind      -- delete the kind
// - display         --                -- display and set display parameters
// - dispref_display --                -- update one field display value
// - dispref_level   --                -- update one field display position 
// External API ---------------------------------------------------------------
// - ext_get_id      -- $title         -- select a company (return id) 
// - ext_get_id_url  -- $url, $title   -- select a company (id), load URL 
///////////////////////////////////////////////////////////////////////////////
</pre>
</td></tr>
</table>
<P>

Names of <i>$action</i> variable should be coherent.
Default actions names should be used :
<ul>
<li>index 
<li>search 
<li>detailconsult 
<li>detailupdate 
<li>new 
<li>insert 
<li>update 
<li>check_delete 
<li>delete 
<li>display
<li>dispref_display
<li>dispref_level
</ul>
and others, specific to the module.


<h3>Module_index.php global variable to define</h3>
the_index.php file must define :
<p>
<table border=1>
<tr>
  <th>variable</th>
  <th>content</th>
</tr><tr>
  <td>$path</td>
  <td>relative path to the obm php root(usually .. for a module)</td>
</tr><tr>
  <td>$menu</td>
  <td>Id of the module (USER, CONTACT,...), module name capitalized</td>
</tr><tr>
  <td>$obminclude</td>
  <td>get from the ENV var : $OBM_INCLUDE_VAR or default to "obminclude"</td>
</tr>
</table>
<p>

Here is a correct module_index.php variable definition :
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
$path = "..";
$menu = "COMPANY";
$obminclude = getenv("OBM_INCLUDE_VAR");
if ($obminclude == "") $obminclude = "obminclude";
</pre>
</td></tr>
</table>
<P>

<h3>Included files : how to, order</h3>
There is 3 global files which are included in all OBM module :
<p>
<ul type=disc>
         <li> <b>(1)</b> obmlib.inc
         <li> <b>(2)</b> global.inc
         <li> <b>(3)</b> global_pref.inc
</ul>
<p>
This order must be respected in all module.<br><br>
<table border=1>
<tr>
  <th>Global file</th>
  <th>Description</th>
</tr><tr>
  <td>obmlib.inc</td>
  <td>This file define the library objects like OBM_Sess, or OBM_DB. It must be included <i><u>before</u></i>
      the call of page_open() in any case.
  </td>
</tr><tr>
  <td>global.inc</td>
  <td>This file define the global variables. In the settings module and in obm.php it must be included <i><u>before</u></i>
      the call of page_open(). In the other case it could be defined before or after page_open().
      For more homogenity we decided to include it before the call of page_open() in any case.
  </td>
</tr><tr>
  <td>global_pref.inc</td>
  <td>This file sets up the global settings. It use some session variable so it must be included
      <i><u>after</u></i> the call of page_open() in any case.
  </td>
</tr>
</table>    

<p>
Here is a correct module_index.php includes bloc :
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
$path = "..";
$menu = "COMPANY";
$obminclude = getenv("OBM_INCLUDE_VAR");
if ($obminclude == "") $obminclude = "obminclude";
require("$obminclude/phplib/obmlib.inc");
include("$obminclude/global.inc");
page_open(array("sess" => "OBM_Session", "auth" => "OBM_Challenge_Auth", "perm" => "OBM_Perm"));
$perm->check("user");
include("$obminclude/global_pref.inc");

require("company_query.inc");
require("company_display.inc");
</pre>
</td></tr>
</table>
<P>


<h3>Main action branch switch</h3>
<i>To do</i>

<h2>Functions</h2>

Each function must have an header, referencing all parameters and the return value (if any).
<br>
Parameters must be described after the line
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
// Parameters:
</pre>
</td></tr>
</table>
<P>

Returned value must be described after the line
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
// Returns:
</pre>
</td></tr>
</table>
<P>

Here is a correct function header :
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
///////////////////////////////////////////////////////////////////////////////
// Company Form Data checking and formatting                                 //
// Parameters:
//   - $cid       : company id
//   - $company[] : values checked
//     keys used  : num, name, zip, phone, fax, web, email
// Returns:
//   - (true | false) : true if data are ok, else false 
///////////////////////////////////////////////////////////////////////////////
</pre>
</td></tr>
</table>
<P>


<ul>
<li><b>Display functions:</b>
<ul>
<li>All variables needed by the display function (other than labels, colors, or session variables) must be transmitted as arguments.
<li>The name of the function is like "dis_module_$$$" (ex. <i> dis_deal_search_form() </I> ).
<li>The file has to be called in the <i>_index.php</i> file with an "include" and not a "require".
</ul>
<br>
<li><b>Query functions:</b><br>
<ul>
<li>The name of the function must be like "run_query_$$$" where "$$$" represent the action performed. 
<li>All variables needed by the query (like label or id) have to be transmitted as arguments.
<li>The OBM_DB object which execute the query is local to the function.
<li>The function return the result of the query.
<li>The file has to be called in the <i>_index.php</i> file with an "include" and not a "require".
</ul>  
</ul>


<h3>Display functions</h3>
Explain separation logic / template where template should consist of html with simple $var. 
<br>
HTML indentation.
<p>
<i>To do</i>


<H2>Debug Infos</H2>
Each user in OBM can set individually its debug level.
The user debug level is stored in the session variable $set_debug.
The debug level is a combination of different debug flags or switches.

<h3>Debug flags defined</h3>
For 0.5.2, OBM defines 3 independant debug switches.

<P>
<TABLE border=1>
<TR>
  <TH>Debug switch (value)</TH>
  <TH>Debug infos to display</TH>
  <TH>Developper Requirements</TH>
</TR><TR>
  <TD><I>$cdg_id (1)</I></TD>
  <TD>Records ID</TD>
  <TD>In the main search query (run_query_search() usually) get the entity_id column as Id (example below)</TD>
</TR><TR>
  <TD><I>$cdg_param (2)</I></TD>
  <TD>Global and session variables</TD>
  <TD>Call display_debug_msg on parameters in main get_param function</TD>
</TR><TR>
  <TD><I>$cdg_sql (4)</I></TD>
  <TD>SQL queries</TD>
  <TD>Call display_debug_msg() on each query (example below)</TD>
</TR>
</TABLE>
<p>

<h3>Developper Requirements</h3>
<h4>$cdg_id</h4>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
  $req = "select Company.*, <b>company_id as Id</b>, companytype_label
          from Company, CompanyType 
          where company_type_id=companytype_id";
</pre>
</td></tr>
</table>

<h4>$cdg_sql</h4>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
  $obm_q = new DB_OBM;
  $query = "select distinct contact_id, contact_lastname, contact_firstname 
            from Contact
            where contact_company_id='$p_id'";
  display_debug_msg($query, $cdg_sql);
  $obm_q->query($query);
</pre>
</td></tr>
</table>
<P>

<h3>Debug functions API</h3>
The $set_debug session variable contains the user current debug level which should be tested against the various switches to display debug information.
<p>
OBM defines these functions (in global.inc) to help test and display debug info.
<h4>debug_level_isset()</h4>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
///////////////////////////////////////////////////////////////////////////////
// Test if the debug flag is set
// Parameters:
//   - $debug : debug flag
// Returns:
//   - true || false : true is flag set
///////////////////////////////////////////////////////////////////////////////
function debug_level_isset($debug) {
  global $set_debug;

  if (($set_debug > 0) && (($set_debug & $debug) == $debug)) {
    return true;
  } else {
    return false;
  }
}
</pre>
</td></tr>
</table>
<P>

debug_level_isset($debug_flag) returns true if the flag is set for the user;
<p><u>Example of use</u>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
if (debug_level_isset($cdg_param)) {
</pre>
</td></tr>
</table>

<h4>display_debug_mesg()</h4>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
///////////////////////////////////////////////////////////////////////////////
// Display a debug message
// Parameters:
//   - $msg         : message to display
//   - $debug (opt) : debug flag required
///////////////////////////////////////////////////////////////////////////////
function display_debug_msg($msg, $debug=0) {
  global $set_debug;

  if (($debug > 0) && (($set_debug & $debug) == $debug)) {
    echo $msg;
    echo "<HR>\n";
  }
}
</pre>
</td></tr>
</table>
<P>


<!-- ---------------------------------------------------------------------- -->
<H2>Date handling</H2>

OBM allow different date representation depending on the user current language.
<br>
Each user in OBM can set individually its language preference.

<h3>Database storage</h3>
Date should be store with data type date fields in database (more clean up is needed here !).
Date for simple date or timestamp for MySQL.


<h3>Developper Requirements</h3>

Date are store as date and are formatted when retrieved from the database.
This can lead to different queries for different database.
<p>
Date Format variables define the date representation.
You can modify date display representation in OBM simply by updating these variables formats.
<p>
At the moment, only variables for the MySQL version are set.

<h4>Date format variables defined in OBM</h4>
These are defined in the lang/$lang/global.inc include file so each module has access to them.
Each language global.inc can hence define its version:
<p>

<table border=1>
<tr>
  <th>Format / Language</th>
  <th>example</th>
</tr><tr>
  <td>ISO</td>
  <td>AAAA-MM-JJ hh:mm:ss</td>
</tr><tr>
  <td>English</td>
  <td>MM-DD-AAAA hh:mm:ss</td>
</tr>
</table>
<p>

<table border=1>
<tr>
  <th>Variable</th>
  <th>Format</th>
  <th>Example</th>
  <th>MySQL FR value</th>
</tr><tr>
  <td>$l_date_format</td>
  <td>simple date (without time info)</td>
  <td>2002-12-31</td>
  <td>%Y-%m-%d</td>
</tr><tr>
  <td>$l_time_format</td>
  <td>simple time (without date info)</td>
  <td>16:51:30</td>
  <td>%H:%i:%s</td>
</tr><tr>
  <td>$l_datetime_format</td>
  <td>complete date info</td>
  <td>2002-12-31 16:51:30</td>
  <td>%Y-%m-%d %H:%i:%s</td>
</tr>
</table>

<h4>MySQL Query Example</h4>

<table bgcolor="C0C0C0">
<tr><td>
<pre>
  $query = "select Deal.*, deal_id as Id,
     dealtype_label,
     ...
     DATE_FORMAT(deal_datealarm,'$l_date_format') as datealarm
...
</pre>
</td></tr>
</table>

<p>


<H2>Variables Names</H2>
Variables names must be explicit without beeing exhaustive.
<BR>
Ex: $param_theme. No $a, $i, $tp neither $parameter_theme_for_settings_screen.
<P>

If more than one word is to be used in a variable name the separator "_" should be used.
<P>

Most variables names should contains a prefix which indicates the variable nature. Here is a list of prefixes used.
<P>

<TABLE border=0>
<TR><TD valign=top align=left>

<TABLE border=1>
<TR><TH colspan=2>HTML Form variables</TH></TR>
<TR><TH>Variable Prefix</TH><TH>Variable Nature</TH></TR>
<TR><TD><I>$tf_</I></TD><TD>Text Field</TD></TR>
<TR><TD><I>$hd_</I></TD><TD>Hidden Field</TD></TR>
<TR><TD><I>$sel_</I></TD><TD>Select</TD></TR>
<TR><TD><I>$sb_</I></TD><TD>Submit Button</TD></TR>
<TR><TD><I>$cb_</I></TD><TD>Checkbox</TD></TR>
<TR><TD><I>$rd_</I></TD><TD>Radio button</TD></TR>
<TR><TD><I>$fl_</I></TD><TD>File</TD></TR>
<TR><TD><I>$ta_</I></TD><TD>Text Area</TD></TR>
<TR><TD><I>$pw_</I></TD><TD>Password</TD></TR>
<TR><TD><I>$form_</I></TD><TD>Form</TD></TR>
</TABLE>

</TD><TD valign=top align=right>

<TABLE border=1 valign=top>
<TR><TH colspan=2>Php variables</TH></TR>
<TR><TH>Variable Prefix</TH><TH>Variable Nature</TH></TR>
<TR><TD><I>$l_</I></TD><TD>label</TD></TR>
<TR><TD><I>$param_</I></TD><TD>parameter</TD></TR>

<TR><TD><I>$col_</I></TD><TD>Color</TD></TR>
<TR><TD><I>$regexp_</I></TD><TD>Regular expression</TD></TR>
<TR><TD><I>$set_</I></TD><TD>Setting</TD></TR>
<TR><TD><I>$img_</I></TD><TD>Image</TD></TR>
</TABLE>

</TD></TR>
</TABLE>



<br><br>


<A HREF="index.html">back</A>

</BODY>
</HTML>

