<HTML>
<HEAD>
<TITLE>Les actions et la gestion des droits OBM </TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF">
<CENTER>
<H1>les actions et droits OBM</H1>
Version 0.6.0
</CENTER>

<br>


<H2>Présentation générale des <i>actions</i></H2>

<H2>Principes des <i>actions</i> : </H2>
<p>
 Le concept d'action est le concept moteur d'OBM. En effet ce sont par celles-ci que seront générées les pages OBM.
Elles définissent, au sein d'un module, la fonctionnalité d'OBM appelée par l'utilisateur.
<p>
 Ainsi la page <b>module_index.php</b> est dans l'attente d'un parametre "action" qui lui permettra d'appeller les
fonctions adequates.  
<p>
Elles sont transmises via les headers html (en POST ou en GET) par le paramètre <b>action</b>, récupéré ensuite dans le code
php par la variable <b>$action</b>
<p>
Par exemple : 
L'utilisateur appelle la page http://obm/deal/deal_index.php?action=index lors du traitement de cette demande,
voici quelle partie du code sera éxécuté :
<table bgcolor="C0C0C0">
<tr><td>
<pre>
if (($action == "index") || ($action == "")) {
///////////////////////////////////////////////////////////////////////////////
  require("deal_js.inc");
  dis_deal_index();
  if ($set_display == "yes") {
    dis_deal_search_list($deal);
  } else {
    display_ok_msg($l_no_display);
  }
</pre>
</td></tr>
</table>
<H2>Gestion des <i>actions</i> : </H2>
<p>
 Afin d'augmenter la généricité du code, à partir de la version 0.6.0 d'OBM, un certain nombre de paramètres sont associés aus
actions. Ces paramètres permettent de générer automatiquement le menu du module, mais également de définir l'action plus précisement,
en lui associant des droits, des conditions d'appelle suivant l'action actuelle, et autres éléments. 
<p>
 Cette gestion est faite grâce à un tableau <b>$actions</b> qui à la structure qui suit :
<table width="10">
<tr>
  <td>$actions</td>
  <td>["Module"]</td>
  <td>["Action"]</td>
  <td>["Name"]</td>
  <td>&nbsp;</td>
</tr><tr>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td>["Url"]</td>
  <td>&nbsp;</td>
</tr><tr>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td>["Pop-Up"]</td>
  <td>&nbsp;</td>
</tr><tr>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td>["Right"]</td>
  <td>&nbsp;</td>
</tr><tr>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
  <td>["Condition"]</td>
  <td nowrap>{"Action list"}</td>
</tr></table>
<p>
<table border=1>
<tr>
  <th colspan=2 align=center>Description de la variable <b>$actions</b></th>
</tr><tr>
  <td>$actions</td>
  <td>Tableau contenant des sous tableaux indéxés par les noms des modules.</td>
</tr><tr>
  <td>$actions["Module"]</td>
  <td>Tableau contenant des sous tableaux indéxés par les noms des actions propres au module <i>Module</i>.</td>
</tr><tr>
  <td>$actions["Module"]["Action"]</td>
  <td>Tableau contenant des sous tableaux indéxés par les noms des paramètres de gestion de l'action <i>Action</i>.</td>
</tr><tr>
  <td>$actions["Module"]["Action"]["Name"]</td>
  <td>Cette variable contient le label de l'action qui sera affiché ( contiendra par exemple, en français, "Chercher" pour l'action <i>Search</i>).</td>
</tr><tr>
  <td>$actions["Module"]["Action"]["Url"]</td>
  <td>Cette variable contient le chemin relatif pour accéder à la page traitant cette action.</td>
</tr><tr>
  <td>$actions["Module"]["Action"]["Right"]</td>
  <td>Cette variable contient les droits necessaires pour éxécuter cette action (pour plus de détail sur les droits consulter le chapitre sur la gestion des droits OBM)</td>
</tr><tr>
  <td nowrap>$action["Module"]["Action"]["Condition"]{"Action 1";"Action 2;...}</td>
  <td>Tableau contenant la liste des actions depuis lesquelles pourra être appelée l'action. Cette liste sera inscrite sous forme de tableau où <i>Action 1</i>, <i>Action 2</i>... sont les noms des actions en question.</td>
</tr>
</table>
<p>
La variable est definit au niveau du fichier <b>global.inc</b> et sera utilisée lors de la génération du menu.
<br>
<p>
<table bgcolor="C0C0C0">
<tr><td>
<pre>
//////////////////////////////////////////////////////////////////////////////
// Company actions
//////////////////////////////////////////////////////////////////////////////

$actions["COMPANY"]["index"] = array ('Name'	 => $l_header_index_f,
            		              'Url' 	 => '$path/company/conmpany_index?action=index',
                                      'Right' 	 => $company_read,
				      'Condition => 'all'; 
                                      );

$actions["COMPANY"]["new"]   = array ('Name'	 => $l_header_new_f,
            		              'Url' 	 => '$path/company/conmpany_index?action=new',
                                      'Right' 	 => $company_write,
				      'Condition => array ( 'index', 'detail_consult','admin','display'); 
                                      );

$actions["COMPANY"]["admin"] = array ('Name'	 => $l_header_admin_f,
            		              'Url' 	 => '$path/company/conmpany_index?action=admin',
                                      'Right' 	 => $company_admin_write,
				      'Condition => array ( 'index', 'detail_consult','display'); 
                                      );

</pre>
</td></tr>
</table>


<h2> Présentation générale du système de gestion des  <i>droits</i> : </h2>

<H2> Introduction au système de gestion des droits d'OBM : </H2>
<p>
Jusqu'a la version 0.6.0 d'OBM, les droits était géré via le système implementé dans PhpLib.
Ce système était géré au niveau de l'objet <b>Perm</b>.
<p>
Les limites du système de PhpLib pour une application sont :
<ul>
<li> Les droits sont définis pour toute l'application, et non au niveau de chaque module. Ainsi un utilisateur ayant les droits
 d'administrateur possedera ces droits sur l'integralité de l'application, et ne pourra pas l'être pour un module uniquement.
<li> La difficulté de definir de nouveaux profils de droits.
</ul>
<p>
Afin de remédier à ces contraintes, un nouveau système de droits  a été défini pour OBM, à partir de sa version 0.6.0.
Ce système definit pour chaque module 4 droits :
<p>
<table border=1>
<tr>
  <th colspan=2 align=center>Description des droits</th>
</tr><tr>
  <td>mod_read</td>
  <td>Droit de lecture basique du module <i>mod</i>.</td>
</tr><tr>
  <td>mod_write</td>
  <td>Droit d'écriture basique du module <i>mod</i>.</td>
</tr><tr>
  <td>mod_admin_read</td>
  <td>Droit de lecture des parties d'administration du module <i>mod</i>.</td>
</tr><tr>
  <td>mod_admin_write</td>
  <td>Droit d'écriture sur les parties d'administration du module <i>mod</i>.</td>
</tr>
</table>
<p>

<H2> Principe du système de gestion des droits d'OBM : </H2>
<p>
<H3> Definission des droits au niveau d'une section : </H3>
Les droits sont définis grâce à des variables globales définient dans le fichier <b>global.inc</b>.
Ces variables sont de la forme <b>$sec_type_droit</b> où <i>sec</i> est le nom de la section pour
laquelle le droit est définit, et <i>type_droit</i> est le droit définit (<i>_read</i>, <i>_write</i>,
<i>_admin_read</i>, <i>_admin_write</i>).
<table bgcolor="C0C0C0">
<tr><td>
<pre>
//////////////////////////////////////////////////////////////////////////////
// Production section rights
//////////////////////////////////////////////////////////////////////////////
$prod_read        = 256;
$prod_write       = 512;
$prod_admin_read  = 1024;
$prod_admin_write = 2048;


</pre>
</td></tr>
</table>

<H3> Definission des droits au niveau d'un module : </H3>

<p>
Les droits d'un module seront définis en fonction des droits de la section à laquelle il appartient.
<table bgcolor="C0C0C0">
<tr><td>
<pre>
//////////////////////////////////////////////////////////////////////////////
// Contract rights
//////////////////////////////////////////////////////////////////////////////
$contract_read        = $prod_read;
$contract_write       = $prod_admin_write;
$contract_admin_read  = $prod_admin_read;
$contract_admin_write = $prod_admin_write;

//////////////////////////////////////////////////////////////////////////////
// Incident rights
//////////////////////////////////////////////////////////////////////////////
$incident_read        = $prod_read;
$incident_write       = $prod_write;
$incident_admin_read  = $prod_admin_read;
$incident_admin_write = $prod_admin_write;

</pre>
</td></tr>
</table>

Les droits sont testés par la fonction <b>have_perms</b>. 

<table bgcolor="C0C0C0">
<tr><td>
<pre>
//////////////////////////////////////////////////////////////////////////////
// Rights test
//////////////////////////////////////////////////////////////////////////////
  if(have_perms($contract_read) ) {
    display_detail($contract_id);
  }
</pre>
</td></tr>
</table>

<H3> Definission des droits au niveau d'un utilisateur : </H3>
<table border="1">
<tr>
  <th colspan="3" align=center>Description des droits des utilisateurs</th>
</tr rowspan="2"><tr>
  <td align=center>Droits</td>
  <td align=center>Opération</td>
  <td align=center>Description</td>
</tr><tr>
</tr><tr>
  <td rowspan="2">$profil</td>
  <td><i>$profil_sec_1</i><b>|</b><i>$profil_sec_2</i> <b>|</b> <i>$profil_sec_3</i> <b>|</b>...</td>
  <td rowspan="2">Droits du profil sur l'ensemble de l'application.avec <i>sec_n</i> les sections de l'application.
     Cette valeur sera celle stockée en base de donnée.</td>
</tr><tr>
  <td bgcolor="C0C0C0">
   <center>
   Exemple :<br>
   <i>$profil</i> = <i>$profil_com | $profil_prod | $profil_admin | $profil_compta</i>.
   </center>
  </td>
</tr><tr>
  <td rowspan="2">$profil_sec</td>
  <td><i>$profil_sec_read</i> <b>|</b> <i>$profil_sec_write</i> <b>|</b> <i>$profil_sec_admin_read</i> 
  <b>|</b> <i>$profil_sec_admin_write</i></td>
  <td rowspan="2">Droit d'un profil sur la section <i>sec</i>.</td>
</tr><tr>
  <td bgcolor="C0C0C0">
   <center>
   Exemple :<br>
   <i>$profil_com</i> = <i>$com_read | $com_write</i>
   </center>
</td>
</tr><tr>
  <td>$profil_sec_act</td>
  <td><i>$profil_sec_act</i> sera égale à <i>$sect_act</i> si le profil à le droit de faire l'action <i>act</i>, 0 sinon.</td>
  <td><i>act</i> peut prendre <i>read</i>, <i>write</i>, <i>admin_read</i>, <i>admin_write</i>.</td>
</tr>
</table>

<p>
Les droits d'un utilisateur seront définis en fonction de son profil.
Les profils utilisateur sont définis dans la base de données.
<p>
Les droits d'un profil seront une combinaison de ses droits sur chaque module.
Par exemple les droits d'un utilisateur ayant un profil de <b>commercial</b> pour la section
<i>com</i> seront : <br>
<i>$profil_com</i> = <i>$com_read | $com_write | $com_admin_read | $com_admin_write</i>.
<br>Pour un technicien ils seront :<br>
<i>$profil_com</i> = <i>$com_read | $com_write</i>.
<p>
Les droits sur l'ensemble de l'application seront  : <br>
<i>$profil</i> = <i>$profil_com | $profil_prod | $profil_admin | $profil_compta</i>.
<p>

<A HREF="index.html">back</A>

</BODY>
</HTML>
